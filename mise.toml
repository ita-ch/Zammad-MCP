# Mise configuration for terraform-homelab
min_version = "2024.9.5"

[settings]
auto_install = true
not_found_auto_install = true
task_run_auto_install = true

[settings.status]
show_tools = true
show_env = false
truncate = true

[tools]
python = "3.14.2"
eza = "0.23.0"
fd = "10.2.0"
rg = "14.1.1"
git-cliff = "2.10.1"
shellcheck = "0.11.0"
markdownlint-cli2 = "0.20.0"
uv = "0.9.17"
prek = "0.2.20"

[env]
_.python.venv = { path = ".venv", create = true } # create the venv if it doesn't exist

# === Setup tasks ===
[tasks.setup]
description = "Set up complete development environment"
run = """
echo "üì¶ Installing Python dependencies..."
uv sync
echo "ü™ù Installing pre-commit hooks..."
pre-commit install
infisical scan install --pre-commit-hook || echo "‚ö†Ô∏è  Infisical not available, skipping..."
if ! command -v coderabbit >/dev/null 2>&1; then
  echo "‚ÑπÔ∏è  CodeRabbit CLI not installed. See mise.toml for installation instructions."
else
  echo "‚úÖ coderabbit CLI already installed."
fi
echo "‚úÖ Development environment ready!"
"""

# === Changelog tasks ===
[tasks.changelog]
description = "Update unreleased section of CHANGELOG.md"
run = """
echo "üìù Updating CHANGELOG.md with unreleased changes..."
# Extract existing content after the first release heading
sed -n '/^## \\[0\\.1\\.3\\]/,$p' CHANGELOG.md > /tmp/changelog_releases.txt
# Generate new unreleased section
git-cliff --unreleased --strip header > /tmp/changelog_unreleased.txt
# Combine: header + unreleased + existing releases
head -7 CHANGELOG.md > CHANGELOG.md.new
cat /tmp/changelog_unreleased.txt >> CHANGELOG.md.new
echo "" >> CHANGELOG.md.new
cat /tmp/changelog_releases.txt >> CHANGELOG.md.new
mv CHANGELOG.md.new CHANGELOG.md
rm /tmp/changelog_unreleased.txt /tmp/changelog_releases.txt
echo "‚úÖ CHANGELOG.md updated!"
"""

[tasks.changelog-bump]
description = "Bump version and update changelog for a release"
usage = 'arg "<version>" help="Version number (e.g., 0.1.4)"'
run = """
echo "üìù Creating release ${usage_version}..."
git-cliff --tag "v${usage_version}" -o CHANGELOG.md
echo "‚úÖ CHANGELOG.md updated for v${usage_version}!"
echo "Next steps:"
echo "  1. Review CHANGELOG.md"
echo "  2. Update version in pyproject.toml"
echo "  3. Commit changes: git add CHANGELOG.md pyproject.toml && git commit -m 'chore: release v${usage_version}'"
echo "  4. Tag release: git tag -a v${usage_version} -m 'Release v${usage_version}'"
echo "  5. Push: git push && git push --tags"
"""

# === Python tasks ===
[tasks.python-clean]
description = "Clean development environment"
run = """
rm -rf .venv
rm -rf requirements.lock
"""

[tasks.python-upgrade]
description = "Upgrade Python dependencies"
run = "uv lock --upgrade"

[tasks.python-install]
description = "Install Python dependencies"
run = "uv sync"

# === Hooks tasks ===
[tasks.hooks-install]
description = "Install pre-commit and infisical hooks"
run = "prek install && infisical scan install --pre-commit-hook"

[tasks.pre-commit-run]
description = "Run pre-commit hooks"
run = "prek run --all-files"

# === Infisical tasks ===
[tasks.infisical-scan]
description = "Scan repository for secrets and sensitive data"
run = "infisical scan"

[tasks.markdown-lint]
description = "Lint Markdown files"
run = "markdownlint-cli2 '**/*.md'"

[tasks.markdown-fix]
description = "Fix Markdown files"
run = "markdownlint-cli2 '**/*.md' --fix"

[tasks.validate-renovate]
description = "Validate Renovate configuration"
run = "npx --yes --package renovate -- renovate-config-validator --strict"
